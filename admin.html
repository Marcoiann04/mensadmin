<script>
  // FIREBASE CONFIGURA QUI (stesso config)
  const firebaseConfig = {
    apiKey: "AIzaSyDmYmIt5jDXMug_OXH0xPP2vyLsy02Alk4",
    authDomain: "mensa-ea014.firebaseapp.com",
    projectId: "mensa-ea014",
    storageBucket: "mensa-ea014.appspot.com",
    messagingSenderId: "341027510429",
    appId: "1:341027510429:web:3d51e97b08ee7d251a9c74",
    measurementId: "G-9B5YYE6CK2"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const passwordClear = "ciao";

  function checkPassword() {
    const input = document.getElementById("passwordInput").value;
    if (input === passwordClear) {
      document.getElementById("admin").style.display = "block";
      document.getElementById("login").style.display = "none";
      loadTable();
    } else {
      alert("Password errata");
    }
  }

  async function addTransaction() {
    const type = document.getElementById("type").value;
    const quantity = parseInt(document.getElementById("quantity").value);
    const price = parseFloat(document.getElementById("price").value);
    const priceType = document.getElementById("priceType").value;

    if (!quantity || !price) {
      alert("Inserisci tutti i campi");
      return;
    }

    let unitPrice;
    if (priceType === "totale") {
      unitPrice = price / (quantity * 10);
    } else {
      unitPrice = price / 10;
    }

    try {
      await db.collection("transactions").add({
        type,
        quantity,
        totalPrice: price,
        unitPrice: parseFloat(unitPrice.toFixed(2)),
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert("Transazione inserita con successo");
      loadTable();
    } catch (e) {
      console.error("Errore inserimento:", e);
      alert("Errore durante l'inserimento");
    }
  }

  async function loadTable() {
    const table = document.getElementById("transactionTable");
    table.innerHTML = `<tr>
      <th>Tipo</th>
      <th>Q.tà blocchetti</th>
      <th>Prezzo totale (€)</th>
      <th>Prezzo per buono (€)</th>
      <th>Data inserimento</th>
      <th>Azioni</th>
    </tr>`;

    try {
      const snapshot = await db.collection("transactions").orderBy("timestamp", "desc").get();
      if (snapshot.empty) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="6">Nessuna transazione presente</td>`;
        table.appendChild(tr);
        return;
      }
      snapshot.forEach(doc => {
        const d = doc.data();
        let dateStr = "-";
        if (d.timestamp && d.timestamp.toDate) {
          dateStr = d.timestamp.toDate().toLocaleString("it-IT");
        }
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${d.type}</td>
          <td>${d.quantity}</td>
          <td>${d.totalPrice.toFixed(2)}</td>
          <td>${d.unitPrice.toFixed(2)}</td>
          <td>${dateStr}</td>
          <td><button onclick="deleteTransaction('${doc.id}')">Elimina</button></td>
        `;
        table.appendChild(row);
      });
    } catch(e) {
      console.error("Errore caricamento dati:", e);
      alert("Errore durante il caricamento dati");
    }
  }

  async function deleteTransaction(id) {
    if (!confirm("Sei sicuro di voler eliminare questa transazione?")) return;
    try {
      await db.collection("transactions").doc(id).delete();
      loadTable();
    } catch(e) {
      console.error("Errore eliminazione:", e);
      alert("Errore durante l'eliminazione");
    }
  }
</script>
